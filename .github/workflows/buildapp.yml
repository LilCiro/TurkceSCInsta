# Bu iÅŸ akÄ±ÅŸÄ± aÅŸaÄŸÄ±daki iÅŸ akÄ±ÅŸlarÄ±ndan bÃ¼yÃ¼k Ã¶lÃ§Ã¼de esinlenilmiÅŸtir:
# https://github.com/arichornlover/uYouEnhanced/blob/main/.github/workflows/buildapp.yml
# https://github.com/ISnackable/YTCubePlus/blob/main/.github/workflows/Build.yml
# https://github.com/BandarHL/BHTwitter/actions/workflows/build.yml

name: SCInsta'yÄ± Derle ve Paketle ğŸ“¦ğŸš€âœ¨ğŸ› ï¸

on:
  workflow_dispatch: # Bu iÅŸ akÄ±ÅŸÄ±nÄ± GitHub arayÃ¼zÃ¼nden manuel olarak tetiklemeye izin verir. ğŸŒğŸ‘†âš™ï¸
    inputs:
      decrypted_instagram_url: # Åifresi Ã§Ã¶zÃ¼lmÃ¼ÅŸ Instagram IPA'sÄ±nÄ±n doÄŸrudan URL'si. ğŸ”—ğŸ”ğŸ“±ğŸ“¥
        description: "Åifresi Ã§Ã¶zÃ¼lmÃ¼ÅŸ Instagram IPA'sÄ±nÄ±n doÄŸrudan URL'si"
        default: ""
        required: true
        type: string
      app_name: # Uygulama adÄ± giriÅŸi (opsiyonel). ğŸ“ğŸ“±âœ¨
        description: "Uygulama AdÄ± (Opsiyonel - BoÅŸ bÄ±rakÄ±lÄ±rsa varsayÄ±lan kullanÄ±lÄ±r)"
        default: ""
        required: false
        type: string
      developer_name: # GeliÅŸtirici adÄ± giriÅŸi (opsiyonel). ğŸ§‘â€ğŸ’»âœï¸ğŸŒŸ
        description: "GeliÅŸtirici AdÄ± (Opsiyonel - BoÅŸ bÄ±rakÄ±lÄ±rsa varsayÄ±lan kullanÄ±lÄ±r)"
        default: ""
        required: false
        type: string
      instagram_app_version: # Instagram uygulama sÃ¼rÃ¼m numarasÄ± giriÅŸi (opsiyonel). ğŸ“±ğŸ”¢âœ¨
        description: "Instagram Uygulama SÃ¼rÃ¼mÃ¼ (Opsiyonel - BoÅŸ bÄ±rakÄ±lÄ±rsa orijinal IPA'nÄ±n sÃ¼rÃ¼mÃ¼ kullanÄ±lÄ±r)"
        default: ""
        required: false
        type: string
      remove_app_icon: # Uygulama fotoÄŸrafÄ±nÄ± kaldÄ±rma seÃ§eneÄŸi (opsiyonel). ğŸ–¼ï¸âŒğŸš«
        description: "Uygulama FotoÄŸrafÄ±nÄ± KaldÄ±r (Opsiyonel - SeÃ§ilirse boÅŸ ikonla derlenir)"
        default: false
        required: false
        type: boolean
      upload_artifact: # OluÅŸturulan paketi GitHub Artifacts'a yÃ¼kleyip yÃ¼klemeyeceÄŸi. ğŸ“¤ğŸ“‚âœ…â˜ï¸
        description: "Derleme sonucunu (artifact) yÃ¼kle"
        default: true
        required: false
        type: boolean
          
concurrency: # AynÄ± anda birden fazla Ã§alÄ±ÅŸtÄ±rmanÄ±n nasÄ±l yÃ¶netileceÄŸini belirler. ğŸš¦ğŸ”„â³ğŸš«
  group: ${{ github.workflow }}-${{ github.ref }} # AynÄ± iÅŸ akÄ±ÅŸÄ± ve referans iÃ§in yalnÄ±zca bir Ã§alÄ±ÅŸtÄ±rmaya izin verir.
  cancel-in-progress: true # Devam eden Ã§alÄ±ÅŸtÄ±rmalarÄ± iptal eder.

jobs:
  build: # Derleme iÅŸi. ğŸ—ï¸ğŸ’»ğŸğŸ“¦
    name: SCInsta'yÄ± Derle ğŸš€âœ¨âœ…ğŸ› ï¸
    runs-on: ubuntu-latest # Ã–nceki hatalarÄ± Ã§Ã¶zmek iÃ§in macOS yerine Ubuntu'ya geÃ§iÅŸ yapÄ±ldÄ±. ğŸ§ğŸ’»
    permissions: # Ä°ÅŸin sahip olduÄŸu izinler. ğŸ”‘ğŸ”’
      contents: write # Depo iÃ§eriÄŸine yazma izni verir. âœï¸

    steps: # Ä°ÅŸin adÄ±mlarÄ±. ğŸ‘£â¡ï¸
      - name: Ana Depoyu Ã‡ek ğŸ“¥ğŸ“‚ğŸ”—ğŸ”„
        uses: actions/checkout@v4 # Depoyu Ã§ekmek iÃ§in checkout eylemini kullanÄ±r.
        with:
          path: main # Depoyu 'main' dizinine Ã§eker.
          submodules: recursive # Alt modÃ¼lleri de Ã¶zyinelemeli olarak Ã§eker.

      - name: Theos'u Kur ve PATH'Ä± Ayarla ğŸğŸ› ï¸âš™ï¸ğŸš€
        uses: actions/checkout@v4 # Theos deposunu Ã§ekmek iÃ§in checkout eylemini kullanÄ±r.
        with:
          repository: theos/theos # Theos'un GitHub deposu.
          ref: master # Master branch'ini Ã§eker.
          path: ${{ github.workspace }}/theos # Theos'u Ã§alÄ±ÅŸma alanÄ±ndaki 'theos' dizinine Ã§eker.
          submodules: recursive # Theos'un alt modÃ¼llerini de Ã¶zyinelemeli olarak Ã§eker.
        # THEOS ortam deÄŸiÅŸkenini ayarla
        run: echo "THEOS=${{ github.workspace }}/theos" >> $GITHUB_ENV

      - name: SDK Ã–nbellekleme ğŸ’¾âš¡ï¸ğŸ“¥ğŸ”„
        id: SDK_Cache # Bu adÄ±m iÃ§in bir ID belirler.
        uses: actions/cache@v4 # Ã–nbellekleme eylemini kullanÄ±r.
        with:
          path: ${{ github.workspace }}/theos/sdks/iPhoneOS14.5.sdk # Ã–nbelleÄŸe alÄ±nacak dizin (SDK'nÄ±n kendisi).
          key: ${{ runner.os }}-sdk-iPhoneOS14.5.sdk-v1 # Ã–nbellek anahtarÄ±.
          restore-keys: ${{ runner.os }}-sdk-iPhoneOS14.5.sdk- # Geri yÃ¼klenecek anahtarlar (SDK'nÄ±n gÃ¼ncel sÃ¼rÃ¼mÃ¼nÃ¼ yakalamak iÃ§in).

      - name: iOS SDK Ä°ndir (Ã–nbellekte Yoksa) â¬‡ï¸ğŸ“±ğŸŒğŸ“¦
        if: steps.SDK_Cache.outputs.cache-hit != 'true' # EÄŸer SDK Ã¶nbellekte yoksa Ã§alÄ±ÅŸÄ±r.
        run: |
          echo "iPhoneOS14.5.sdk indiriliyor ve theos/sdks iÃ§ine yerleÅŸtiriliyor..."
          mkdir -p ${{ github.workspace }}/theos/sdks # SDK dizininin var olduÄŸundan emin ol.
          # GitHub release veya baÅŸka bir gÃ¼venilir kaynaktan SDK'yÄ± indirme
          # **Ã–NEMLÄ°: Bu URL'yi gerÃ§ek, geÃ§erli bir SDK indirme URL'si ile deÄŸiÅŸtirmeniz gerekir.**
          # Genellikle bu SDK'lar doÄŸrudan bir git deposunda olmaz, release varlÄ±klarÄ±dÄ±r.
          wget -q https://github.com/xybp888/iOS-SDKs/releases/download/v14.5/iPhoneOS14.5.sdk.zip -O iPhoneOS14.5.sdk.zip || { echo "SDK indirme hatasÄ±!"; exit 1; }
          unzip -q iPhoneOS14.5.sdk.zip -d ${{ github.workspace }}/theos/sdks/ || { echo "SDK aÃ§ma hatasÄ±!"; exit 1; }
          rm iPhoneOS14.5.sdk.zip # Ä°ndirilen zip dosyasÄ±nÄ± temizle
          echo "iPhoneOS14.5.sdk baÅŸarÄ±yla indirildi ve yerleÅŸtirildi."
        env:
          THEOS: ${{ github.workspace }}/theos # THEOS ortam deÄŸiÅŸkenini ayarlar.

      - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle ğŸ“¦ğŸ”§âš™ï¸ğŸ“š
        run: |
          sudo apt-get update
          sudo apt-get install -y ldid unzip build-essential fakeroot # dpkg'ye ihtiyacÄ±mÄ±z olursa diye fakeroot eklendi
          # make (GNU Make) Ubuntu'da varsayÄ±lan olarak zaten 'make' adÄ±yla kuruludur.
          echo "BaÄŸÄ±mlÄ±lÄ±klar yÃ¼klendi."
          
      - name: Instagram IPA'yÄ± Ä°ndir ve HazÄ±rla ğŸ“±ğŸ“¦ğŸ”—ğŸ“¥
        run: |
          cd main # Ana depo dizinine gider.
          mkdir -p packages # 'packages' dizini oluÅŸturur.
          echo "Instagram IPA'sÄ± indiriliyor: ${{ inputs.decrypted_instagram_url }}"
          wget "${{ inputs.decrypted_instagram_url }}" --no-verbose -O packages/com.burbn.instagram.ipa || { echo "Instagram IPA indirme hatasÄ±!"; exit 1; }
          ls -la packages # 'packages' dizininin iÃ§eriÄŸini listeler.
          # Ä°ndirilen IPA'nÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et
          if [ ! -f "packages/com.burbn.instagram.ipa" ]; then
            echo "Hata: packages/com.burbn.instagram.ipa indirilemedi veya bulunamadÄ±!"
            exit 1
          fi
          echo "Instagram IPA baÅŸarÄ±yla indirildi ve doÄŸrulandÄ±."
            
        env:
          THEOS: ${{ github.workspace }}/theos # THEOS ortam deÄŸiÅŸkenini ayarlar.

      - name: SCInsta Tweak SÃ¼rÃ¼mÃ¼nÃ¼ Al ğŸ·ï¸ğŸ”¢âœ¨ğŸ“„
        id: scinsta_version # Bu adÄ±m iÃ§in bir ID belirler.
        run: |
          SCINSTA_TWEAK_VERSION=$(awk '/Version:/ {print $2}' main/control)
          echo "SCInsta tweak sÃ¼rÃ¼mÃ¼ control dosyasÄ±ndan alÄ±ndÄ±: ${SCINSTA_TWEAK_VERSION}"
          echo "SCINSTA_TWEAK_VERSION=${SCINSTA_TWEAK_VERSION}" >> "$GITHUB_ENV" # Ortam deÄŸiÅŸkeni olarak ayarla
          echo "version=${SCINSTA_TWEAK_VERSION}" >> "$GITHUB_OUTPUT" # Ã‡Ä±ktÄ± olarak ayarla

      - name: SCInsta tweak'i sideload iÃ§in derle (IPA olarak) ğŸ—ï¸ğŸ“±ğŸš€ğŸ“¦
        run: |
          # pyzule-rw Ubuntu'da da Ã§alÄ±ÅŸÄ±r.
          pip install --force-reinstall https://github.com/asdfzxcvbn/pyzule-rw/archive/main.zip || { echo "pyzule-rw kurulum hatasÄ±!"; exit 1; }
            
          cd main # Ana depo dizinine gider.
          echo "main dizini iÃ§eriÄŸi:"
          ls -la # Dizin iÃ§eriÄŸini listeler.

          # Uygulama adÄ±, geliÅŸtirici adÄ±, ikon kaldÄ±rma ve Instagram sÃ¼rÃ¼m argÃ¼manlarÄ±nÄ± hazÄ±rla
          BUILD_SCRIPT_ARGS="sideload"
          if [[ -n "${{ inputs.app_name }}" ]]; then
            BUILD_SCRIPT_ARGS+=" --uygulama-adi \"${{ inputs.app_name }}\""
          fi
          if [[ -n "${{ inputs.developer_name }}" ]]; then
            BUILD_SCRIPT_ARGS+=" --gelistirici-adi \"${{ inputs.developer_name }}\""
          fi
          if [[ "${{ inputs.remove_app_icon }}" == "true" ]]; then
            BUILD_SCRIPT_ARGS+=" --remove-app-icon"
          fi
          if [[ -n "${{ inputs.instagram_app_version }}" ]]; then
            BUILD_SCRIPT_ARGS+=" --instagram-sÃ¼rÃ¼mÃ¼ \"${{ inputs.instagram_app_version }}\""
          fi

          echo "build.sh Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor: ./build.sh $BUILD_SCRIPT_ARGS"
          bash ./build.sh $BUILD_SCRIPT_ARGS || { echo "build.sh Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken hata oluÅŸtu!"; exit 1; }

          echo "packages/ dizini iÃ§eriÄŸi (derleme sonrasÄ±):"
          ls -la packages # 'packages' dizininin iÃ§eriÄŸini listeler.
            
        env:
          # THEOS ve THEOS_SDK_PATH artÄ±k burada doÄŸrudan kullanÄ±lÄ±yor
          THEOS: ${{ github.workspace }}/theos
          THEOS_SDK_PATH: ${{ github.workspace }}/theos/sdks/iPhoneOS14.5.sdk

      - name: IPA'yÄ± sÃ¼rÃ¼m bilgisiyle yeniden adlandÄ±r ğŸ·ï¸ğŸ”„ğŸ“¦âœ¨
        run: |
          cd main/packages # 'packages' dizinine gider.
          # SCINSTA_TWEAK_VERSION env deÄŸiÅŸkeni bu adÄ±mda kullanÄ±labilir.
          # En son oluÅŸturulan .ipa dosyasÄ±nÄ± bulmak iÃ§in dikkatli olun
          IPA_FILE=$(find . -maxdepth 1 -name "*.ipa" -print -quit)
          if [ -z "$IPA_FILE" ]; then
            echo "Hata: packages/ dizininde IPA dosyasÄ± bulunamadÄ±!"
            exit 1
          fi
          mv "$IPA_FILE" "SCInsta_sideloaded_v${SCINSTA_TWEAK_VERSION}.ipa" || { echo "IPA yeniden adlandÄ±rma hatasÄ±!"; exit 1; }
          echo "IPA baÅŸarÄ±yla yeniden adlandÄ±rÄ±ldÄ±: SCInsta_sideloaded_v${SCINSTA_TWEAK_VERSION}.ipa"
          ls -la # Yeniden adlandÄ±rma sonrasÄ± dizin iÃ§eriÄŸini listeler.

        env:
          SCINSTA_TWEAK_VERSION: ${{ env.SCINSTA_TWEAK_VERSION }} # scinsta_version adÄ±mÄ±ndan gelen env deÄŸiÅŸkenini kullan

      - name: Paket adÄ±nÄ± yÃ¼kleme eylemine ilet ğŸ“¤ğŸ“‚â¡ï¸ğŸ”—
        id: package_name # Bu adÄ±m iÃ§in bir ID belirler.
        run: |
          # Yeniden adlandÄ±rÄ±lan IPA dosyasÄ±nÄ±n adÄ±nÄ± bulmak iÃ§in
          RENAMED_IPA=$(find main/packages -maxdepth 1 -name "*.ipa" -print -quit)
          if [ -z "$RENAMED_IPA" ]; then
            echo "Hata: Yeniden adlandÄ±rÄ±lan IPA dosyasÄ± bulunamadÄ±!"
            exit 1
          fi
          echo "package=$(basename "$RENAMED_IPA")" >> "$GITHUB_OUTPUT" # En son paketin adÄ±nÄ± Ã§Ä±ktÄ± olarak ayarlar.

      - name: Artifact YÃ¼kle â¬†ï¸ğŸ“¦â˜ï¸âœ…
        if: ${{ inputs.upload_artifact }} # EÄŸer 'upload_artifact' giriÅŸi doÄŸru ise Ã§alÄ±ÅŸÄ±r.
        uses: actions/upload-artifact@v4 # Artifact yÃ¼kleme eylemini kullanÄ±r.
        with:
          name: SCInsta_sideloaded_v${{ steps.scinsta_version.outputs.version }} # YÃ¼klenecek artifact'in adÄ±.
          # YÃ¼kleme iÃ§in tam yolu kullan
          path: ${{ github.workspace }}/main/packages/${{ steps.package_name.outputs.package }} 
          if-no-files-found: error # Dosya bulunamazsa hata verir.
