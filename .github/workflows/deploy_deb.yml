name: DEB Paketini Depoya YÃ¼kle ve Depoyu GÃ¼ncelle ğŸš€ğŸ“¦

on:
  workflow_run:
    # Bu, 'TurkceSCInsta' deposundaki 'Build and Package SCInsta' iÅŸ akÄ±ÅŸÄ± tamamlandÄ±ÄŸÄ±nda tetiklenir
    workflows: ["Build and Package SCInsta"]
    types:
      - completed # Sadece baÅŸarÄ±lÄ± tamamlanmalarda Ã§alÄ±ÅŸÄ±r

jobs:
  deploy_deb:
    if: ${{ github.event.workflow_run.conclusion == 'success' }} # Sadece derleme baÅŸarÄ±lÄ±ysa devam et
    runs-on: ubuntu-latest
    permissions:
      contents: none
      actions: write # Bu iÅŸ akÄ±ÅŸÄ±nÄ±n kendi Ã§alÄ±ÅŸtÄ±rmalarÄ±nÄ± yÃ¶netmesi iÃ§in gerekli

    steps:
      - name: Derleme Ä°ÅŸ AkÄ±ÅŸÄ± Artifact'larÄ±nÄ± Ä°ndir ğŸ“¥
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }},
            });
            // Buradaki artifact adÄ±, buildapp.yml dosyasÄ±ndaki DEB artifact adÄ± ile aynÄ± olmalÄ±.
            // Ã–nceki Ã¶rneklerde 'SCInsta_deb_v${{ steps.scinsta_version.outputs.version }}' idi.
            // Bu deÄŸeri doÄŸru ÅŸekilde eÅŸleÅŸtirdiÄŸinden emin ol!
            const matchArtifact = artifacts.data.artifacts.find(artifact => artifact.name.startsWith("SCInsta_deb_v")); 
            if (!matchArtifact) {
              console.log("DEB artifact bulunamadÄ± veya adÄ± eÅŸleÅŸmiyor, atlanÄ±yor.");
              return;
            }
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
            });
            const fs = require('fs');
            fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/deb_artifact.zip`, Buffer.from(download.data));
          
          env:
            # Buradaki bilgiler DEB paketlerini barÄ±ndÄ±racaÄŸÄ±n ayrÄ± depona ait
            DEB_REPO_SLUG: "LilCiro/scinsta-repo" # Kendi depo adÄ±nla deÄŸiÅŸtirildi
            DEB_REPO_BRANCH: "gh-pages" # Genellikle GitHub Pages iÃ§in kullanÄ±lÄ±r

      - name: Ä°ndirilen Artifact'Ä± Ã‡Ä±kar ğŸ“¦
        run: |
          mkdir -p deb_output
          unzip deb_artifact.zip -d deb_output || { echo "Hata: Artifact Ã§Ä±karÄ±lamadÄ±."; exit 1; }
          DEB_FILE=$(find deb_output -name "*.deb" -print -quit)
          if [ -z "$DEB_FILE" ]; then
            echo "Hata: Ã‡Ä±karÄ±lan artifact iÃ§inde .deb dosyasÄ± bulunamadÄ±."
            exit 1
          fi
          echo "DEB_FILE_PATH=$DEB_FILE" >> $GITHUB_ENV
          echo "DEB_FILENAME=$(basename $DEB_FILE)" >> $GITHUB_ENV

      - name: Depo Klonla ve HazÄ±rla ğŸŒ¿
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DEB_REPO_SLUG }}
          ref: ${{ env.DEB_REPO_BRANCH }}
          token: ${{ secrets.DEB_REPO_TOKEN }} # SCInsta projenin deposuna eklediÄŸin secret
          path: deb_repo # Depoyu bu dizine Ã§eker

      - name: Yeni DEB Paketini Ekle ve Depoyu GÃ¼ncelle âœ¨
        working-directory: deb_repo
        run: |
          mkdir -p debs # 'debs' klasÃ¶rÃ¼ yoksa oluÅŸtur
          cp "${{ github.workspace }}/${{ env.DEB_FILE_PATH }}" debs/ || { echo "Hata: .deb dosyasÄ± kopyalanamadÄ±."; exit 1; }

          echo "Packages dosyasÄ± gÃ¼ncelleniyor..."
          # dpkg-scanpackages Theos'un kurulu olduÄŸu ortamda olmalÄ±
          # Bu komut iÃ§in PATH'e theos/bin ekli olduÄŸundan emin olun veya tam yolu verin
          dpkg-scanpackages -m debs /dev/null > Packages || { echo "Hata: Packages dosyasÄ± oluÅŸturulamadÄ±."; exit 1; }
          gzip -c Packages > Packages.gz || { echo "Hata: Packages.gz sÄ±kÄ±ÅŸtÄ±rÄ±lamadÄ±."; exit 1; }

          # Release dosyasÄ±nÄ± kendi bilgilerinizle dÃ¼zenleyin!
          echo "Origin: SCInsta Tweak Deposu" > Release
          echo "Label: SCInsta" >> Release
          echo "Suite: stable" >> Release
          echo "Version: 1.0" >> Release # Depo sÃ¼rÃ¼mÃ¼nÃ¼zÃ¼ gÃ¼ncelleyebilirsiniz
          echo "Codename: ios" >> Release
          echo "Architectures: iphoneos-arm" >> Release
          echo "Components: main" >> Release
          echo "Description: Instagram deneyiminizi geliÅŸtiren SCInsta tweakleri." >> Release
          
          echo "MD5Sum:" >> Release
          md5sum Packages | awk '{print " " $1 " Packages"}' >> Release
          md5sum Packages.gz | awk '{print " " $1 " Packages.gz"}' >> Release

          echo "SHA1:" >> Release
          sha1sum Packages | awk '{print " " $1 " Packages"}' >> Release
          sha1sum Packages.gz | awk '{print " " $1 " Packages.gz"}' >> Release

          echo "SHA256:" >> Release
          sha256sum Packages | awk '{print " " $1 " Packages"}' >> Release
          sha256sum Packages.gz | awk '{print " " $1 " Packages"}' >> Release

      - name: DeÄŸiÅŸiklikleri Commit Et ve Push Et ğŸ“¤
        working-directory: deb_repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Otomatik: Yeni SCInsta DEB paketi eklendi ve depo gÃ¼ncellendi" || echo "DeÄŸiÅŸiklik yok, commit atlanÄ±yor."
          git push
        env:
          GH_TOKEN: ${{ secrets.DEB_REPO_TOKEN }} # Git push iÃ§in bu token'Ä± kullan

      - name: TamamlandÄ± ğŸ‰
        run: echo "DEB paketi baÅŸarÄ±yla depoya yÃ¼klendi ve depo gÃ¼ncellendi."
